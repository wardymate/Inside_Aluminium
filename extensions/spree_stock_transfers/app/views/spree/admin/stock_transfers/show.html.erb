<%= javascript_tag do %>
  $(document).ready(function(){
    $("#flip").click(function(){
        $("#panel").slideDown("slow");
      });
  });
<% end %>

<% content_for :page_title do %>
   Purchase Order (<%= @stock_transfer.number %>)
<% end %>

<% content_for :page_actions do %>
  <%= button_link_to Spree.t(:new_purchase_order), new_admin_stock_transfer_path, { :icon => 'add', :class => 'btn-success' } %>
<% end if can? :create, Spree::StockTransfer %>

<fieldset>

  <table class="table table-bordered">
    <tr>
      <td width="30%"><strong><%= Spree.t(:created_at) %></strong></td>
      <td><%= @stock_transfer.created_at %></td>
    </tr>
    <tr>
      <td width="30%"><strong><%= Spree.t(:status) %></strong></td>
      <td><%= @stock_transfer.status %></td>
    </tr>
    <% if @stock_transfer.status == 'Created' %>
    <tr>
      <td width="30%"><strong><%= Spree.t(:required_action) %></strong></td>
      <td> This order has not yet been sent to Stylmark. Please click 'View Items' to review the contents of this order and make any required ammendments. When you are satisfied, please click 'Progress Purchase Order'. </td>
    </tr>
    <% end %>
  </table>

    <% @a = @stock_transfer.stock_movements.map { |h| h[:estimated_arrival_date]}.uniq %>
    <% @a.sort! %>
    <% relevant_stock_movements_1 = @stock_transfer.stock_movements.where(estimated_arrival_date: @a[0]) %>
    <% relevant_stock_movements_2 = @stock_transfer.stock_movements.where(estimated_arrival_date: @a[1]) %>
    <% relevant_stock_movements_3 = @stock_transfer.stock_movements.where(estimated_arrival_date: @a[2]) %>

    <span id='flip'><button type="button" class="btn btn-secondary" style='color: white' style='float:left'>View Items</button><span>

    <div id='panel'>
      <br>

      <% if @a.size >= 1 && relevant_stock_movements_1.any? {|h| h[:sales_order_id] == nil } %>
        <%= render partial: 'stock_movements', locals: {relevant_date: @a[0]} %>
      <% else %>
        <%= render :partial => 'completed_stock_movements', locals: {relevant_date: @a[0]}  %>
      <% end %>


      <% if @a.size < 2 %>
        <%= %>
      <% elsif @a.size >= 2 && relevant_stock_movements_2.any? {|h| h[:sales_order_id] == nil }%>
        <%= render :partial => 'stock_movements', locals: {relevant_date: @a[1]} %>
      <% else %>
        <%= render :partial => 'completed_stock_movements', locals: {relevant_date: @a[1]} %>
      <% end %>

      <% if @a.size < 3 %>
        <%= %>
      <% elsif @a.size >= 3 && relevant_stock_movements_3.any? {|h| h[:sales_order_id] == nil } %>
        <%= render :partial => 'stock_movements', locals: {relevant_date: @a[2]}  %>
      <% else %>
        <%= render :partial => 'completed_stock_movements', locals: {relevant_date: @a[2]} %>
      <% end %>

      <span><%= button_link_to "Add New Part Number", new_1_admin_stock_transfer_stock_movements_path(@stock_transfer), class: 'btn-success' %></span>

    </div>
</fieldset>
<br>
<% if @stock_transfer.status == 'Created' %>
  <span style='float:left'><%= button_link_to Spree.t(:progress_purchase_order), edit_admin_stock_transfer_path, class: 'btn-primary' %></span>
<% else %>
  <span style='float:left'><%= button_link_to Spree.t(:amend_purchase_order), edit_admin_stock_transfer_path, { :class => 'btn-primary' } %></span>
<% end %>

<%= button_link_to "Delete Purchase Order", admin_stock_transfer_path(@stock_transfer), class: 'btn-danger',  method: :delete, data: { confirm: 'Are you sure?' } %>
